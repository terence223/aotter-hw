{"version":3,"sources":["aotterAd.js"],"names":["window","document","jsonpCallbackName","API_URL","Aotter","type","scriptEle","createElement","src","body","appendChild","eventName","cb","waitingForEmit","eventList","jsonpCallback","res","ad","adWasShown","success","aotterAd","emit","width","image","alt","title","height","video_url","getElementById","handler","raf","showOverHalf","setTimeout","removeEventListener","fetch","impression_url","mode","addEventListener","ele","scroll","scrollY","pageYOffset","boundTop","getBoundingClientRect","top","view","innerHeight","bound","clientHeight","halfHeight","requestAnimationFrame","webkitRequestAnimationFrame","mozRequestAnimationFrame","callback"],"mappings":";AAAA,SAAA,EAAA,EAAA,GAAA,KAAA,aAAA,GAAA,MAAA,IAAA,UAAA,qCAAA,SAAA,EAAA,EAAA,GAAA,IAAA,IAAA,EAAA,EAAA,EAAA,EAAA,OAAA,IAAA,CAAA,IAAA,EAAA,EAAA,GAAA,EAAA,WAAA,EAAA,aAAA,EAAA,EAAA,cAAA,EAAA,UAAA,IAAA,EAAA,UAAA,GAAA,OAAA,eAAA,EAAA,EAAA,IAAA,IAAA,SAAA,EAAA,EAAA,EAAA,GAAA,OAAA,GAAA,EAAA,EAAA,UAAA,GAAA,GAAA,EAAA,EAAA,GAAA,EAAA,SAAA,EAAA,EAAA,EAAA,GAAA,OAAA,KAAA,EAAA,OAAA,eAAA,EAAA,EAAA,CAAA,MAAA,EAAA,YAAA,EAAA,cAAA,EAAA,UAAA,IAAA,EAAA,GAAA,EAAA,GAAA,SAAUA,EAAQC,EAAUC,GAElBC,IAEAC,EAJqC,WAAA,SAAA,IAAA,EAAA,KAAA,GAM3B,EAAA,KAAA,YAAA,IAGK,EAAA,KAAA,iBAAA,CACG,gBAAA,EACA,gBAAA,EACI,oBAAA,IAZe,OAAA,EAAA,EAAA,CAAA,CAAA,IAAA,SAgBrB,MAAA,WAAXC,IAAAA,EAAO,UAAA,OAAA,QAAA,IAAA,UAAA,GAAA,UAAA,GAAA,GACJC,EAAYL,EAASM,cAAc,UACzCD,EAAUE,IAASL,GAAAA,OAhBX,kCAgB2BE,UAAAA,OAAAA,GACnCJ,EAASQ,KAAKC,YAAYJ,KAnBS,CAAA,IAAA,KAuBpCK,MAAAA,SAAAA,EAAWC,GACP,KAAKC,eAAeF,IACnBC,IACKC,KAAAA,eAAeF,IAAa,GAG5BG,KAAAA,UAAUH,GAAaC,IA7BG,CAAA,IAAA,OAmClCD,MAAAA,SAAAA,GACE,KAAKG,UAAUH,GACTG,KAAAA,UAAUH,KAGVE,KAAAA,eAAeF,IAAa,MAxCF,EAAA,GA6C3CX,EAAM,cAGGe,SAAcC,GACfC,IAAAA,EACAC,GAAa,EACd,IAACF,EAAIG,QAEJ,YADAC,SAASC,KAAK,gBAIF,WAAbL,EAAIX,OACHY,EAAKhB,EAASM,cAAc,QACzBe,MAAQ,MACXL,EAAGT,IAAMQ,EAAIO,MACbN,EAAGO,IAAMR,EAAIS,OAEI,UAAbT,EAAIX,QACRY,EAAKhB,EAASM,cAAc,WACzBe,MAAQ,MACXL,EAAGS,OAAS,MACZT,EAAGT,IAAMQ,EAAIW,WAGjB1B,EAAS2B,eAAe,oBAAoBlB,YAAYO,GACxDG,SAASC,KAAK,gBAGRQ,IAAAA,EAAU,SAAVA,IAAgBC,OAAAA,EAAI,WACnBC,EAAa9B,EAAS2B,eAAe,sBACpCI,WAAW,WACJD,EAAa9B,EAAS2B,eAAe,uBAAyBV,IAC7DA,GAAa,EACblB,EAAOiC,oBAAoB,SAAUJ,GACrCT,SAASC,KAAK,oBACda,MAAMlB,EAAImB,eAAgB,CACtBC,KAAM,cAGf,QAIXP,IACA7B,EAAOqC,iBAAiB,SAAUR,IAIhCE,IAAAA,EAAe,SAAAO,GACXC,IAAAA,EAASvC,EAAOwC,SAAWxC,EAAOyC,YAClCC,EAAWJ,EAAIK,wBAAwBC,IAAML,EAE7CM,EACGN,EADHM,EAEMN,EAASvC,EAAO8C,YAGtBC,EACGL,EADHK,EAEML,EAAWJ,EAAIU,aAGrBC,EAAaX,EAAIU,aAAe,EAE5BD,OAAAA,EAAeE,GAAeJ,GAAYE,GAAgBF,GAAoBE,EAAYE,GAAeJ,GAAeE,GAAaF,GAG7If,EACF9B,EAAOkD,uBACPlD,EAAOmD,6BACPnD,EAAOoD,0BACP,SAAUC,GACNrD,EAAOgC,WAAYqB,EAAU,IAAO,KAG5CrD,EAAOoB,SAAW,IAAIhB,EAxH1B,CA0HGJ,OAAQC","file":"aotterAd.js","sourceRoot":"..","sourcesContent":["(function(window, document, jsonpCallbackName) {\n    // API 位址\n    const API_URL = 'http://localhost:3000/ads/jsonp';\n\n    class Aotter {\n        // 記錄用 on 註冊的事件的 callback\n        eventList = {}\n        \n        // 若 emit 時還沒被用 on 設定，先用這個變數記錄下來，當使用者一用 on 設定就可以馬上 emit\n        waitingForEmit = {\n            \"on-ad-loaded\": false,\n            \"on-ad-failed\": false,\n            \"on-ad-impression\": false\n        }\n\n        // 載入廣告的函式，參數 type 為 BANNER 和 VIDEO\n        loadAd(type = '') {\n            const scriptEle = document.createElement('script');\n            scriptEle.src = `${API_URL}?type=${type}`;\n            document.body.appendChild(scriptEle);\n        }\n\n        // 設定監聽事件的函式\n        on(eventName, cb) {\n            if(this.waitingForEmit[eventName]) {\n                cb();\n                this.waitingForEmit[eventName] = false;\n            }\n            else {\n                this.eventList[eventName] = cb\n            }\n            \n        }\n\n        // 觸發監聽事件的 callback\n        emit(eventName) {\n            if(this.eventList[eventName]) {\n                this.eventList[eventName]();\n            }\n            else {\n                this.waitingForEmit[eventName] = true;\n            }\n        }\n    }\n    \n    window[jsonpCallbackName] = jsonpCallback;\n\n    // 接收 jsonp 資料的函式\n    function jsonpCallback(res) {\n        let ad;\n        let adWasShown = false;\n        if(!res.success) {\n            aotterAd.emit('on-ad-failed');\n            return;\n        }\n\n        if(res.type === 'BANNER') {\n            ad = document.createElement('img');\n            ad.width = '560'\n            ad.src = res.image;\n            ad.alt = res.title;\n        }\n        else if(res.type === 'VIDEO') {\n            ad = document.createElement('iframe');\n            ad.width = '560'\n            ad.height = '315'\n            ad.src = res.video_url\n        }\n    \n        document.getElementById('aotter-ad-plugin').appendChild(ad);\n        aotterAd.emit('on-ad-loaded');\n        \n        // 測試廣告是不是顯示超過一秒\n        const handler = () => raf(() => {\n            if(showOverHalf(document.getElementById('aotter-ad-plugin'))) {\n                setTimeout(function() {\n                    if(showOverHalf(document.getElementById('aotter-ad-plugin')) && !adWasShown) {\n                        adWasShown = true;\n                        window.removeEventListener('scroll', handler);\n                        aotterAd.emit('on-ad-impression');\n                        fetch(res.impression_url, {\n                            mode: 'no-cors'\n                        })\n                    }\n                }, 1000)\n            }\n        } )\n            \n        handler()\n        window.addEventListener('scroll', handler)\n    }\n\n    // 測試元件是不是顯示超過 50%\n    const showOverHalf = ele => {\n        const scroll = window.scrollY || window.pageYOffset\n        const boundTop = ele.getBoundingClientRect().top + scroll\n        \n        const view = {\n            top: scroll,\n            bottom: scroll + window.innerHeight,\n        }\n        \n        const bound = {\n            top: boundTop,\n            bottom: boundTop + ele.clientHeight,\n        }\n        \n        const halfHeight = ele.clientHeight / 2\n        \n        return ( (bound.bottom - halfHeight) >= view.top && bound.bottom <= view.bottom ) || ( (bound.top + halfHeight) <= view.bottom && bound.top >= view.top );\n    }\n\n    const raf = \n        window.requestAnimationFrame ||\n        window.webkitRequestAnimationFrame ||\n        window.mozRequestAnimationFrame ||\n        function( callback ) {\n            window.setTimeout( callback, 1000 / 60 )\n        }\n\n    window.aotterAd = new Aotter();\n\n})(window, document, 'jsonpCallback')"]}